#!/bin/bash

# Ghana Chatbot - Backend Startup Script
# Run from Final/ directory

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
echo "Script directory: $SCRIPT_DIR"
cd "$SCRIPT_DIR/backend"
echo "Changed to: $(pwd)"

echo "Starting Ghana Chatbot Backend"
echo "========================================"

# Check if virtual environment exists
if [ ! -d ".venv" ]; then
    echo "Creating virtual environment..."
    python3 -m venv .venv
fi

# Activate virtual environment
echo "Activating virtual environment..."
source .venv/bin/activate

# Install/update dependencies
echo "Installing dependencies..."
pip install --upgrade pip

# Install dependencies (simpler list for demo)
echo "Installing core dependencies..."
pip install flask flask-cors ollama requests beautifulsoup4

# Optional dependencies (install if needed, but don't fail)
echo "Installing optional dependencies (may fail but that's OK)..."
pip install chromadb==0.4.22 || echo "ChromaDB install failed (will use fallback)"
pip install selenium webdriver-manager || echo "Selenium install failed (optional)"
pip install pdfplumber pymupdf || echo "PDF libraries failed (optional)"

# Check Ollama
echo ""
echo "Checking Ollama..."
if command -v ollama &> /dev/null; then
    echo "Ollama is installed"
    ollama list || echo "Ollama not running. Please run 'ollama serve' in another terminal"
else
    echo "WARNING: Ollama not found. Please install Ollama from https://ollama.ai"
fi

echo ""
echo "========================================"
echo "Setup complete! Starting server..."
echo ""
echo "IMPORTANT: Make sure Ollama is running in another terminal:"
echo "  ollama serve"
echo ""
echo "If you see errors about missing packages, they're optional."
echo "The chatbot will work with Ollama-only fallback mode."
echo ""

# Run the Flask app
echo "Starting backend server..."
"$SCRIPT_DIR/backend/.venv/bin/python" "$SCRIPT_DIR/backend/app.py"